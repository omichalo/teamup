# Firebase Functions - SQY Ping TeamUp

Ce dossier contient les Firebase Functions pour la synchronisation automatique des donn√©es FFTT.

## üöÄ Fonctions disponibles

### 1. `syncMatches` (Scheduled Function)
- **D√©clenchement** : Automatique tous les jours √† 2h du matin (heure de Paris)
- **R√¥le** : Synchronise tous les matchs et leurs d√©tails depuis l'API FFTT
- **Stockage** : Sauvegarde les donn√©es dans Firestore (`matches` collection)

### 2. `triggerMatchSync` (HTTP Function)
- **URL** : `https://us-central1-sqyping-teamup.cloudfunctions.net/triggerMatchSync`
- **M√©thode** : POST
- **R√¥le** : D√©clenche manuellement la synchronisation des matchs
- **Usage** : Pour forcer une mise √† jour imm√©diate

## üìã Configuration

Les variables d'environnement sont configur√©es via Firebase Functions Config :

```bash
# Configuration FFTT
fftt.id = "SW251"
fftt.pwd = "XpZ31v56Jr"
fftt.club_code = "08781477"
```

## üõ†Ô∏è Scripts disponibles

```bash
# Configuration des variables d'environnement
npm run functions:setup

# Compilation des Functions
npm run functions:build

# Test local avec √©mulateur
npm run functions:test

# D√©ploiement vers Firebase
npm run functions:deploy

# Voir les logs
npm run functions:logs
```

## üìä Structure des donn√©es

### Collection `matches`
Chaque document contient :
- `id` : Identifiant unique du match
- `teamNumber` : Num√©ro de l'√©quipe SQY PING
- `opponent` : Nom de l'√©quipe adverse
- `date` : Date du match
- `score` : Score du match (si termin√©)
- `result` : R√©sultat (VICTOIRE/DEFAITE/NUL/√Ä VENIR)
- `resultatsIndividuels` : D√©tails des compositions et r√©sultats individuels
- `isFemale` : true si √©quipe f√©minine
- `division` : Division FFTT
- `epreuve` : Libell√© de l'√©preuve FFTT

### Collection `metadata`
- `lastSync` : Timestamp de la derni√®re synchronisation
- `count` : Nombre de matchs synchronis√©s

## üîÑ Processus de synchronisation

1. **R√©cup√©ration des √©quipes** : Filtre les √©preuves 15954 (Masculin) et 15955 (F√©minin)
2. **Parall√©lisation** : R√©cup√®re tous les matchs en parall√®le
3. **Traitement par batch** : Traite les d√©tails des matchs termin√©s par groupes de 3
4. **Enrichissement** : Compl√®te les donn√©es manquantes (licences, points) via `getJoueursByClub`
5. **Sauvegarde** : Stocke tout dans Firestore avec timestamps

## üö® Gestion des erreurs

- **API FFTT indisponible** : Cr√©ation de d√©tails basiques avec les informations disponibles
- **Donn√©es manquantes** : Enrichissement automatique via la liste des joueurs du club
- **Limitation de d√©bit** : Traitement par batch avec d√©lais pour √©viter la surcharge

## üìà Performance

- **Parall√©lisation** : R√©cup√©ration initiale en parall√®le (26 √©quipes)
- **Batch processing** : Traitement des d√©tails par groupes de 3 avec d√©lai de 1s
- **Cache Firestore** : √âvite les appels API r√©p√©t√©s
- **Enrichissement intelligent** : Compl√®te seulement les donn√©es manquantes

## üîß Maintenance

### Logs
```bash
# Voir les logs en temps r√©el
npm run functions:logs

# Logs sp√©cifiques √† une fonction
firebase functions:log --only syncMatches
firebase functions:log --only triggerMatchSync
```

### Synchronisation manuelle
```bash
# Via curl
curl -X POST https://us-central1-sqyping-teamup.cloudfunctions.net/triggerMatchSync

# Via l'interface Firebase Console
# Functions > triggerMatchSync > Test
```

### Monitoring
- **Firebase Console** : Functions > Monitoring
- **Cloud Logging** : Logs d√©taill√©s de chaque ex√©cution
- **M√©triques** : Temps d'ex√©cution, erreurs, invocations
