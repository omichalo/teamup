name: Deploy to Production

on:
  push:
    branches:
      - main
    paths-ignore:
      - "**.md"
      - ".github/workflows/*.md"
      - "docs/**"
      - "README.md"

jobs:
  deploy:
    name: Deploy to Firebase App Hosting
    runs-on: ubuntu-latest
    # Ne dÃ©ployer que si ce n'est pas un commit de merge automatique
    if: github.event_name == 'push' && !contains(github.event.head_commit.message, 'Merge pull request')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run type-check
        run: npm run type-check

      - name: Build application
        run: npm run build

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Authenticate with Firebase Service Account
        env:
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          if [ -z "$FIREBASE_SERVICE_ACCOUNT_JSON" ]; then
            echo "âŒ Erreur: Le secret FIREBASE_SERVICE_ACCOUNT n'est pas dÃ©fini"
            exit 1
          fi
          SERVICE_ACCOUNT_FILE="${{ github.workspace }}/firebase-service-account.json"
          printf '%s\n' "$FIREBASE_SERVICE_ACCOUNT_JSON" > "$SERVICE_ACCOUNT_FILE"
          if ! python3 -m json.tool "$SERVICE_ACCOUNT_FILE" > /dev/null 2>&1; then
            echo "âŒ Erreur: Le fichier JSON du service account est invalide"
            exit 1
          fi
          gcloud auth activate-service-account --key-file="$SERVICE_ACCOUNT_FILE"
          echo "âœ… Service account authentifiÃ©: $(gcloud config get-value account)"
          echo "SERVICE_ACCOUNT_FILE=$SERVICE_ACCOUNT_FILE" >> $GITHUB_ENV

      - name: Deploy to Firebase App Hosting
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.SERVICE_ACCOUNT_FILE }}
        run: |
          echo "ğŸš€ DÃ©ploiement sur Firebase App Hosting..."
          firebase deploy --only apphosting \
            --project sqyping-teamup \
            --non-interactive

      - name: Cleanup
        if: always()
        run: |
          if [ -f "${{ github.workspace }}/firebase-service-account.json" ]; then
            rm -f "${{ github.workspace }}/firebase-service-account.json"
            echo "ğŸ§¹ Fichier de service account supprimÃ©"
          fi

      - name: Deployment summary
        run: |
          echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s"
          echo "ğŸŒ Application disponible sur: https://teamup--sqyping-teamup.us-east4.hosted.app"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Auteur: ${{ github.event.head_commit.author.name }}"

